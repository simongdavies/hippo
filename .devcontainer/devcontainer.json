// For format details, see https://aka.ms/devcontainer.json. For config options, see the README at:
// https://github.com/microsoft/vscode-dev-containers/tree/v0.187.0/containers/dotnet
{
    "name": "C# (.NET)",
    "build": {
        "dockerfile": "Dockerfile",
        "args": {
            // Update 'VARIANT' to pick a .NET Core version: 2.1, 3.1, 5.0
            "VARIANT": "5.0",
            // Options
            "NODE_VERSION": "lts/*",
            "HIPPO_VERSION": "v0.7.0",
            "BINDLE_VERSION": "v0.4.1",
            "WAGI_VERSION": "v0.3.0",
            "TRAEFIK_VERSION": "v2.5.2"
        }
    },
    // Set *default* container specific settings.json values on container create.
    "settings": {
        "remote.autoForwardPorts": false
    },
    // Add the IDs of extensions you want installed when the container is created.
    "extensions": [
        "ms-dotnettools.csharp"
    ],
    "containerEnv": {
        "BINDLE_URL": "http://localhost:8080/v1",
        "HIPPO_URL": "https://localhost:5001",
        "GLOBAL_AGENT_FORCE_GLOBAL_AGENT": "false",
        // This places bindle server data in the workspace so that state is retained across multiple invocations of the bindle server 
        // Delete this folder and Hippo/hippo.db.* files to reset Hippo
        "BINDLE_DIRECTORY" : "${containerWorkspaceFolder}/bindleserver/data",
        "IP_ADDRESS" : "127.0.0.1"
    },
    // Use 'forwardPorts' to make a list of ports inside the container available locally.
    // 4646 is the Nomad Web UI HTTP port
    // 5001 is the Hippo HTTPS Port
    // 5002 is the YARP HTTP Port, this is forwarded as the certificate for the YARP server is not trusted and therefore HTTPS cannot be proxied, applications are exposed here when using the default and Wagi schedulers.
    // 8081 is the Traefik Web UI HTTP Port
    // 8088 is the Traefik Proxy HTTP Port, applications are exposed here when using the nomad scheduler
    // 8200 is the Vault Web UI HTTP Port
    // 8500 is the Consul Web UI Port
    // 32768 is the first port that is used by applications launched from Hippo enbled schedulers, normally this would not be accessed directly but through the proxy endpoint on port 5002 or 8088.
    "forwardPorts": [
        4646,
        5001,
        5002,
        8081,
        8088,
        8200,
        8500,
        32768
    ],
    // Comment out connect as root instead. More info: https://aka.ms/vscode-remote/containers/non-root.
    "remoteUser": "vscode",
    "updateRemoteUserUID": false,
    // restore and build the application, add the dev cert. 
    "postCreateCommand": "cd Hippo && dotnet restore && npm run build && dotnet build && dotnet dev-certs https",
    "portsAttributes": {
        "4646": {
            "label": "Nomad Web UI",
            "protocol": "http"
        },
        "5001": {
            "label": "Hippo HTTPS Port",
            "protocol": "https"
        },
        "5002": {
            "label": "YARP HTTP Endpoint",
            "protocol": "http"
        },
        "8081": {
            "label": "Traefik Web UI",
            "protocol": "http"
        },
        "8088": {
            "label": "Traefik Proxy HTTP Endpoint",
            "protocol": "http"
        },
        "8200": {
            "label": "Vault Web UI",
            "protocol": "http"
        },
        "8500": {
            "label": "Consul Web UI",
            "protocol": "http"
        },
        "32768": {
            "label": "Application Channel HTTP Port",
            "protocol": "http"
        }
    }
}